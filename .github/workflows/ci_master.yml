
name: CI

on: [pull_request, push]

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  generic_ci:
    # Placeholder Job
    name: Placeholder Job
    # Set the type of machine to run on
    runs-on: ubuntu-latest

    steps:
      # Print something
      - name: Placeholder printing
        run: echo "Placeholder printing"

      - name: Another Step
        run: echo "another step"

  failed_job:
    # The easiest way to deal with that to exclude the job that can faile from the merge checks on github
    # That way the issue will be visible in the PR but can still be merged
    name: Failed Job allowed to fail
    runs-on: ubuntu-latest
    steps:
      - name: Fail Step
        run: exit 1

  matrix_expansion_job:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.8, 3.7, 3.6]
        django-db: [SQLITE, POSTGRES]
    name: Python ${{ matrix.python-version }} - Django DB ${{ matrix.django-db }}
    steps:
      - uses: actions/checkout@v2
      - name: Set Environment Variables
        env:
          DJANGO_DB: ${{ matrix.django-db }}
          TOX_SKIP_ENV: ".*all_filter_volume_test.*"
        run: |
          echo DJANGO_DB: $DJANGO_DB
          echo TOX_SKIP_ENV: $TOX_SKIP_ENV
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Dependencies
        run: pip install coverage tox-gh-actions
      - name: Run Tests
        run: |
          coverage erase
          # Run tox using the version of Python in `PATH`
          tox -e py
      - name: Handle Coverage
        run: |
          coverage combine --append
          coverage report -m

  run_linters:
    runs-on: ubuntu-latest
    name: Latest Dev - Linting and Checks
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: Setup Env
        run: |
          pip --version
          python --version --version
          python -c "import sqlite3; print('sqlite3 Version on Python:', sqlite3.sqlite_version)"
          pip list
          python -m pip install --upgrade pip pipenv
          pip list
      - name: Install Dependencies
        run: |
          # don't use the '--upgrade' to not upgrade pinned requirements with generic ones
          pip install -r requirements.txt
          pip list
      - name: Run Linters
        run: ./dev/run_linters.sh

  run_safety_checks:
    runs-on: ubuntu-latest
    name: Check Package Safety (Failure Allowed)
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: Setup Env
        run: |
          pip --version
          python --version --version
          python -c "import sqlite3; print('sqlite3 Version on Python:', sqlite3.sqlite_version)"
          pip list
          python -m pip install --upgrade pip pipenv
          pip list
      - name: Install Dependencies
        run: |
          # don't use the '--upgrade' to not upgrade pinned requirements with generic ones
          pip install -r requirements.txt
          pip list
      - name: Run Package Safety
        run: ./dev/check_package_safety.sh
